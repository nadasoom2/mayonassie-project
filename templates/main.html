<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë§ˆìš”ë„¤ì¦ˆ ë©”ì¸</title>
   <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
   <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet" />
 
  <style>
    /* ì „ì²´ ë ˆì´ì•„ì›ƒì›ƒ */
    body {
      background-color: #fffdf4;
      font-family: 'Gowun Dodum', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #ffb300;
      font-size: 3rem;
      margin-top: 40px;
      margin-bottom: 10px;
    }

    h2 {
      color: #666;
      font-size: 1.2rem;
      margin-bottom: 30px;
    }

    /* ìƒë‹¨ ê³ ì •ë°” (ì½”ì¸ + ì¶œì„ ë²„íŠ¼) */
    #header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff7cc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    #header-bar .greeting {
      font-size: 1.2rem;
      color: #333;
    }

    #header-bar .controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    /* ë©”ì¸ ë²„íŠ¼ ê·¸ë£¹ë£¹ */
    .button-group {
      display: flex;
      gap: 20px;
      margin: 20px 0 40px;
    }

    .button-group a button {
      background-color: #ffcc80;            /* ë°ì€ ì˜¤ë Œì§€í†¤ ë°°ê²½ */
      color: #5d4037;                       /* ì§„í•œ ê°ˆìƒ‰ ê¸€ììƒ‰ (ê°€ë…ì„± UP) */
      padding: 14px 30px;                   /* ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°± */
      border: none;                         /* í…Œë‘ë¦¬ ì œê±° */
      border-radius: 30px;                  /* ë‘¥ê·¼ ëª¨ì„œë¦¬ (pill ë²„íŠ¼ ëŠë‚Œ) */
      font-size: 1rem;                      /* ê¸€ì í¬ê¸° */
      cursor: pointer;                      /* ë§ˆìš°ìŠ¤ ì»¤ì„œ ì†ê°€ë½ ëª¨ì–‘ */
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
      transition: transform 0.3s, background-color 0.3s; /* í˜¸ë²„ íš¨ê³¼ ë¶€ë“œëŸ½ê²Œ */
    }

    .button-group a button:hover {
      background-color: #ffa726;            /* í˜¸ë²„ ì‹œ ìƒ‰ ë” ì§„í•˜ê²Œ */
      transform: translateY(-3px);          /* ë²„íŠ¼ì´ ì‚´ì§ ìœ„ë¡œ ëœ¨ëŠ” ëŠë‚Œ */
    }


    /* ë©”ì¸ ìº˜ë¦°ë” (FullCalendar ì˜ì—­ ) */
    #calendar {
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    /* ìº˜ë¦°ë” ì´ë²¤íŠ¸ ëª¨ë‹¬ */
    #calendarModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff9ec;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 420px;
      width: 90%;
      font-size: 0.95rem;
      text-align: left;
    }

    #calendarModal h3 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #ff9800;
    }

    #calendarModal button {
      margin-top: 20px;
      background-color: #ffb74d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #calendarModal button:hover {
      background-color: #fb8c00;
    }

    #modalBackdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
    }

    /* Footer */
    .footer {
      margin-top: 50px;
      font-size: 0.9rem;
      color: #aaa;
      padding-bottom: 30px;
    }

    /* ì¶œì„ ì²´í¬ íŒì—… (ë¯¸ë‹ˆ ë‹¬ë ¥) */
    #attendance-popup-container {
      display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
    }

    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff9e1;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      width: 350px;
      z-index: 10001;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .calendar-header h2 {
      color: #b58800;
      margin: 0;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day-name, .day {
      text-align: center;
      font-size: 14px;
      padding: 8px 0;
    }
    .day-name { font-weight: bold; color: #b58800; }
    .day { background: #fff3c4; border-radius: 10px; color: #5f4b00; }
    .today { border: 2px solid #ffcc00; background-color: #fff0b3; font-weight: bold; }
    .checked { background-color: #ffe58f; color: #4b3c00; font-size: 16px; font-weight: bold; }
    .attend-button {
      margin-top: 15px;
      text-align: center;
    }
    
    .attend-button button {
      background-color: #ffd966;
      color: #5f4b00;
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
    }

    .atd_box {
      position: fixed;
      top: 25px;
      right: 135px; /* ì½”ì¸ë°”ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ìœ ë¥¼ ë‘” ê°’ */
      padding: 10px 20px;
      background: #ffd54f;
      border: none;
      border-radius: 12px;
      color: #4e3c00;
      font-weight: bold;
      z-index: 999;
      cursor: pointer;
    }

    #coin-bar {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #FFD700; /* ì§„í•œ ë…¸ë€ìƒ‰ */
      border-radius: 12px;
      padding: 8px 14px;
      color: #222; /* ëˆˆì— ì˜ ë„ëŠ” ì–´ë‘ìš´ ê¸€ììƒ‰ */
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transition: transform 0.1s ease;
    }

    #coin-bar:hover {
      transform: scale(1.03);
    }

    #coin-bar img {
      width: 28px;
      height: 28px;
    }

  </style>

</head>
<body>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    fetch("/check_attendance_dates")
      .then(res => res.json())
      .then(data => {
        document.getElementById("coinCount").textContent = data.coins + "ê°œ";
      })
      .catch(err => {
        console.error("ì½”ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      });
  });
  </script>

  <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="username">{{ userid }}</span>ë‹˜!</h1>
  <h2>ì˜¤ëŠ˜ ë‹¹ì‹ ì˜ ë§ˆìŒì€ ì–´ë–¤ê°€ìš”?</h2>

  <!-- ì¶œì„ì²´í¬ì™€ ë³´ìœ  ì½”ì¸ -->
    <div id="coin-bar" onclick="window.location.href='/buy-coins'">
      <img src="/static/coin.png" alt="ì½”ì¸">
      <span id="coinCount">{{ coins }}</span>
    </div>

<button class="atd_box" onclick="openAttendancePopup()">ì¶œì„ì²´í¬</button>



  <!-- FullCalendar -->
  <div id="calendar"></div>

  <div class="button-group">
    <a href="/survey"><button>ì„¤ë¬¸ í•˜ëŸ¬ ê°€ê¸°</button></a>
    <a href="/diary"><button>ì¼ê¸° ì“°ëŸ¬ ê°€ê¸°</button></a>
    <a href="/letterwriting"><button>í¸ì§€ ì“°ëŸ¬ ê°€ê¸°</button></a>
  </div>

  <!-- ìº˜ë¦°ë” ëª¨ë‹¬ ë°•ìŠ¤ -->
  <div id="calendarModal">
    <div id="modalContent">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <button onclick="closeModal()">ë‹«ê¸°</button>
  </div>
  <div id="modalBackdrop" onclick="closeModal()"></div>

  <!-- ì¶œì„ì²´í¬ íŒì—… body -->
  <div id="attendance-popup-container" style="display: none;">
    <div class="popup">
      <div class="calendar-header">
        <button onclick="changeMonth(-1)">â—€</button>
        <h2 id="month-title">ì›”</h2>
        <button onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="calendar" id="attendance-calendar"></div>
      <div class="attend-button">
        <button class="attend" onclick="markAttendance()">ì¶œì„í•˜ê¸°</button>
        <button onclick="closeAttendancePopup()" style="background-color:#eee; color:#555;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div class="footer">
    010@naver.com - ë¬¸ì œ ìˆì„ ì‹œ ë©”ì¼ ë‚¨ê²¨ì£¼ì„¸ìš”!
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  
  <script>
    // ìº˜ë¦°ë” ì´ë²¤íŠ¸ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function closeModal() {
      document.getElementById("calendarModal").style.display = "none";
      document.getElementById("modalBackdrop").style.display = "none";
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ìº˜ë¦°ë”(FullCalendar) ëœë”ë§ 
    document.addEventListener('DOMContentLoaded', function () {
      // ë©”ì¸ FullCalendar (ì¼ê¸°/ì„¤ë¬¸ìš©)
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: 'auto',
        contentHeight: 'auto',
        fixedWeekCount: false,
        contentHeight: 400,

        // ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì„¤ë¬¸/ì¼ê¸°)
        events: async function(fetchInfo, successCallback, failureCallback) {
          try {
            const res = await fetch(`/calendar/calendar-diary-range?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`);
            const data = await res.json();
            const events = data.map(d => ({
              title: 'ğŸ“˜',
              start: d.date,
              allDay: true
            }));
            successCallback(events);
          } catch (err) {
            failureCallback(err);
          }
        },
        
        // ë‚ ì§œ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        dateClick: function (info) {
          fetch(`/calendar/calendar-data?date=${info.dateStr}`)
            .then(res => res.json())
            .then(data => {
              const html = `
                <strong>ğŸ“… ${info.dateStr}</strong><br/><br/>
                ğŸ§  <strong>ì„¤ë¬¸ ë©”ëª¨:</strong><br/>
                <div style="margin-left:10px; margin-bottom:10px;">${data.memo || "ì—†ìŒ"}</div>
                ğŸ““ <strong>ì¼ê¸° ë‚´ìš©:</strong><br/>
                <div style="margin-left:10px;">${data.diary ? data.diary.slice(0, 100) + "..." : "ì—†ìŒ"}</div><br/>
                <a href="/diary?date=${info.dateStr}"><button>ì¼ê¸° ìì„¸íˆ ë³´ê¸°</button></a>
              `;
              document.getElementById("modalContent").innerHTML = html;
              document.getElementById("calendarModal").style.display = "block";
              document.getElementById("modalBackdrop").style.display = "block";
            });
        }
      });
      calendar.render();

      // ì¶œì„ ì²´í¬ìš© ë¯¸ë‹ˆ ë‹¬ë ¥ í˜¸ì¶œ
      maybeShowAttendancePopupOncePerDay();  // ìë™ ì¶œì„ íŒì—…
    });

    //ì¶œì„ ì²´í¬ ìš© ë¯¸ë‹ˆ ë‹¬ë ¥ ë¡œì§ì§
    let currentDate = new Date();
    let attendanceDates  = []; 

    // ì¶œì„ì²´í¬ - ì£¼ì–´ì§„ ë‚ ì§œ í˜•ì‹ ë³€í™˜
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ì¶œì„ ë‹¬ë ¥ - ë‹¬ë ¥ ê·¸ë¦¬ê¸° (ê° ë‚ ì§œì— ì²´í¬ì—¬ë¶€)
    function generateCalendar(date) {
      const calendar = document.getElementById("attendance-calendar");
      const monthTitle = document.getElementById("month-title");
      calendar.innerHTML = "";

      const year = date.getFullYear();
      const month = date.getMonth();
      const today = new Date();

      const firstDay = new Date(year, month, 1);
      const lastDate = new Date(year, month + 1, 0).getDate();
      const startDay = firstDay.getDay();

      // ìš”ì¼ ì´ë¦„ ì¶”ê°€ê°€
      const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      dayNames.forEach(day => {
        const div = document.createElement("div");
        div.className = "day-name";
        div.textContent = day;
        calendar.appendChild(div);
      });

      // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
      for (let i = 0; i < startDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      // ë‚ ì§œë³„ ì…€ ì¶”ê°€ê°€
      for (let d = 1; d <= lastDate; d++) {
        const cell = document.createElement("div");
        const thisDate = new Date(year, month, d);
        const dateStr = formatDate(thisDate);
        cell.className = "day";

        // ì´ë¯¸ ì¶œì„í•œ ë‚ ì§œë¼ë©´ ì²´í¬ í‘œì‹œ
        if (attendanceDates.includes(dateStr)) {
          cell.classList.add("checked");
          cell.textContent = "âœ”";
        } else {
          cell.textContent = d;
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ìŠ¤íƒ€ì¼ ê°•ì¡°
        if (
          d === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) {
          cell.classList.add("today");
        }

        calendar.appendChild(cell)
      }

      monthTitle.textContent = `${month + 1}ì›”`;
    }

    // ì—°ì† ì¶œì„ì¼ ê³„ì‚° í•¨ìˆ˜
    function getConsecutiveAttendanceDays(attendanceList) {
      // attendanceListëŠ” 'YYYY-MM-DD' ë¬¸ìì—´ ë°°ì—´, ì •ë ¬ í•„ìš”
      attendanceList.sort();
      let count = 1; // ì˜¤ëŠ˜ ì¶œì„ í¬í•¨ ê°€ì •

      for (let i = attendanceList.length - 1; i > 0; i--) {
        const current = new Date(attendanceList[i]);
        const prev = new Date(attendanceList[i - 1]);
        const diffDays = (current - prev) / (1000 * 60 * 60 * 24);
        if (diffDays === 1) {
          count++;
        } else if (diffDays > 1) {
          break;  // ì—°ì† ëŠê¹€
        }
      }
      return count;
    }

    // ì´ì „/ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
    function changeMonth(diff) {
      currentDate.setMonth(currentDate.getMonth() + diff);
      generateCalendar(currentDate);
    }

    // ì¶œì„ ì²´í¬ ë²„íŠ¼ í´ë¦­ ì‹œ 
    function markAttendance() {
      const todayStr = formatDate(new Date());

      // ì´ë¯¸ ì¶œì„í•œ ë‚ ì´ë©´ ì¤‘ë³µ ë°©ì§€
      if (attendanceDates.includes(todayStr)) {
        alert("ì´ë¯¸ ì¶œì„í–ˆì–´ìš”!");
        return;
      }

      // ì„œë²„ì— ì¶œì„ ê¸°ë¡ ì €ì¥
      fetch("/check_attendance", {
        method: "POST",
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // 1. ì˜¤ëŠ˜ ë‚ ì§œ ì¶œì„ ëª©ë¡ì— ì¶”ê°€
            attendanceDates.push(todayStr);
            localStorage.setItem(`attendance_${userId}`, JSON.stringify(attendanceDates));

            // 2. ì—°ì† ì¶œì„ì¼ ê³„ì‚°
            const streak = getConsecutiveAttendanceDays(attendanceDates);
            const daysLeft = 5 - streak;

            if (daysLeft > 0) {
              alert(`ì¶œì„ ì™„ë£Œ! ì½”ì¸ íšë“ê¹Œì§€ ì•ìœ¼ë¡œ ${daysLeft}ì¼`);
            } else {
              alert("ì¶•í•˜í•©ë‹ˆë‹¤! ì—°ì† 5ì¼ ì¶œì„ìœ¼ë¡œ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!");
            }

            // 3. ì½”ì¸ ìˆ˜ UI ì—…ë°ì´íŠ¸
            document.getElementById('coinCount').textContent = data.coins;

            // 4. ìº˜ë¦°ë” ê°±ì‹ 
            generateCalendar(currentDate);
          } else {
            alert("ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        })
        .catch(err => {
          console.error("ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }


    // ì¶œì„ì²´í¬ -íŒì—… ì—´ê¸° - DBì—ì„œ ì¶œì„ ë‚ ì§œì™€ coins ê°€ì ¸ì˜´
    function openAttendancePopup(isAuto = false) {
      const todayStr = new Date().toISOString().split("T")[0];

      // âœ… ìë™ í˜¸ì¶œì¸ë° ì˜¤ëŠ˜ ì´ë¯¸ ìë™ íŒì—… ë„ì› ë‹¤ë©´ ë¬´ì‹œ
      if (isAuto && localStorage.getItem(`popupShown_${userId}_${todayStr}`) === "true") {
        console.log("â›” ì´ë¯¸ ì˜¤ëŠ˜ ìë™ íŒì—… ë„ì› ìŒ. ë¬´ì‹œí•¨.");
        return;
      }

      // âœ… ì„œë²„ì—ì„œ ì¶œì„ ë‚ ì§œ + ì½”ì¸ ìˆ˜ ë°›ì•„ì˜¤ê¸°
      fetch("/check_attendance_dates")
        .then(res => res.json())
        .then(data => {
          attendanceDates = data.dates || [];
          document.getElementById("coinCount").textContent = data.coins;
          generateCalendar(currentDate);
          document.getElementById("attendance-popup-container").style.display = "block";

          // âœ… ìë™ í˜¸ì¶œì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” localStorage í”Œë˜ê·¸ ì €ì¥
          if (isAuto) {
            localStorage.setItem(`popupShown_${userId}_${todayStr}`, "true");
          }
        })
        .catch(err => {
          console.error("ì¶œì„ ë‚ ì§œ/ì½”ì¸ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", err);
        });
    }



  // ì¶œì„ì²´í¬ - íŒì—… ë”
    function closeAttendancePopup() {
      document.getElementById("attendance-popup-container").style.display = "none";
    }

    // ì˜¤ëŠ˜ ë‚ ì§œ í˜•ì‹ ë°˜í™˜
    function getTodayDateStr() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function maybeShowAttendancePopupOncePerDay() {
      const todayStr = new Date().toISOString().split("T")[0];
      const key = `popupShown_${userId}_${todayStr}`;
      if (!localStorage.getItem(key)) {
        openAttendancePopup(true);
      }
    }

    // ë°±ì—”ë“œì—ì„œ ë°›ì€ useridê°€ ì—†ì„ ê²½ìš° fallback ì²˜ë¦¬
    const userIdFromServer = "{{ userid }}";

    // undefined or ë¹ˆ ë¬¸ìì—´ì´ë©´ localStorage fallback
    const userId = (userIdFromServer && userIdFromServer !== "None") ? userIdFromServer : (localStorage.getItem("userId") || "guest");

    // username í‘œì‹œ
    document.addEventListener('DOMContentLoaded', () => {
      const usernameEl = document.getElementById("username");
      if (usernameEl) {
        usernameEl.textContent = userId;
      }

      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê°±ì‹ 
      if (userIdFromServer && userIdFromServer !== "None") {
        localStorage.setItem("userId", userIdFromServer);
      }
    });
  </script>
</body>
</html>
